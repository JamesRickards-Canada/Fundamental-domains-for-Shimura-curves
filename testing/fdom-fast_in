\r fdom;

testalgfdom(L) = {
  my(F, A, X, elts, S, P, g, word, newword);
  for (i = 1, #L,
    for (j = 1, #L[i][1],
      F = nfinit(L[i][1][j]);
      A = alginit(F, L[i][2][j]);
      X = afuchinit(A, , , 1);
      elts = afuchelts(X);
      S = afuchsignature(X);
      print(S);/*Invariant.*/
      X = afuchmakepresentation(X);
      P = afuchpresentation(X);
      g = algmulvec(A, elts, vector(5 + random(15), k, (2*random(2) - 1)*(random(#elts) + 1)));/*Random norm 1 element.*/
      word = afuchword(X, g);
      newg = algmulvec(A, P[1], word);
      if(newg == g || newg == -g, print("Passed word test"), print("Failed word test"));
      /*if(algelttype(A, g)==1,geod=algfdomrootgeodesic(g, U));/*No error should be raised if this works.*/
    );
  );
}

As=vector(3);/*Various algebras*/
As[1] = [[y, y, y, y], [[3, 1], [-21, 11], [-117, 2627], [923, -4476549]]];
As[2] = [[y^2 - 10, y^2 - y - 17], [[-8*y + 9, -y + 1], [-2*y + 6, 8*y - 111]]];
As[3] = [[y^3 - 3*y - 1, y^3 - 4*y - 1], [[3*y^2 - 5*y - 8, 84*y^2 - 140*y - 223], [-38*y^2 + 124*y - 93, 5*y^2 - 11*y - 20]]];
testalgfdom(As);

/*Time for some Eichler orders.*/

/*We store an order as a vector of basis elements, written in the algebraic representation. This converts it to a matrix, whose columns express each basis element in terms of the natural order of A.*/
algorderalgtomatrix(A, algelts)={
  my(n, M);
  n = #algelts;/*Number of elements*/
  M = matrix(n, n);
  for (i = 1, n, M[, i] = algalgtobasis(A, algelts[i]));
  return(M);
}
/*
Code to make the algebraic reps for the bases:
algmakeorderalg(A, ord) = {
  my(n = 4*A[1].nf.r1);
  if (ord == 0, ord = matid(n));
  return(liftall(vector(n, i, algbasistoalg(A, ord[, i]))))
}
*/

setrand(1);
F = nfinit(y);
setrand(1);/*Issue is the Eichler orders contained within need to correspond to the precomputed maximal order.*/
A = alginit(F, [2, 1]);/*Unramified*/

O1bas = [[1, 0]~, [5*x, 0]~, [4*x + 1/2, 1/2]~, [17/4*x, 1/4*x]~];/*Level 5*/
O1 = algorderalgtomatrix(A, O1bas);
if(!algisorder(A, O1), print("Not an order"));
print(algorderlevel(A, O1, 0));
X = afuchinit(A, O1, , 2);
print(afuchsignature(X));
X = afuchmakepresentation(X);
P = afuchpresentation(X);
print(length(P[1]));

O1bas = [[1, 0]~, [97*x, 0]~, [57*x + 1/2, 1/2]~, [265/4*x, 1/4*x]~];/*Level 97*/
O1 = algorderalgtomatrix(A, O1bas);
if(!algisorder(A, O1), print("Not an order"));
print(algorderlevel(A, O1, 0));
X = afuchinit(A, O1, , 2);
print(afuchsignature(X));
X = afuchmakepresentation(X);
P = afuchpresentation(X);
print(length(P[1]));

setrand(1);
A = alginit(F, [3, -1]);/*Ramified at 2, 3*/

O1bas = [[1, 0]~, [37*x, 0]~, [18*x, 1]~, [21/2*x + 1/2, 1/2*x + 1/2]~];/*Level 37*/
O1 = algorderalgtomatrix(A, O1bas);
if(!algisorder(A, O1),print("Not an order"));
print(algorderlevel(A, O1, 0));
X = afuchinit(A, O1, , 2);
print(afuchsignature(X));
X = afuchmakepresentation(X);
P = afuchpresentation(X);
print(length(P[1]));

setrand(1);
A = alginit(F, [105, -8]);/*Ramified at 5, 7*/

O1bas = [[1, 0]~, [1/2*x - 1/2, 0]~, [0, 2]~, [1/3*x, 1/24*x + 15/8]~];/*Level 4*/
O1 = algorderalgtomatrix(A, O1bas);
if(!algisorder(A, O1), print("Not an order"));
print(algorderlevel(A, O1, 0));
X = afuchinit(A, O1, , 2);
print(afuchsignature(X));
X = afuchmakepresentation(X);
P = afuchpresentation(X);
print(length(P[1]));

setrand(1);
F = nfinit(y^2 - 2);
setrand(1);
A = alginit(F,  [-7*y + 1, -15*y + 17]);/*Ramified at the prime above 2*/

O1bas = [[1, 0]~, [-y, 0]~, [9*x, 0]~, [-9*y*x, 0]~, [(-6*y + 5)*x, 1]~, [(-5/2*y + 6)*x, -1/2*y]~, [(-1/2*y + 7/2)*x + 1/2, 1/2*x + 1/2]~, [(-1311/194*y + 949/194)*x + (-1/2*y + 1/2), (-1/31234*y + 5709/31234)*x + (-73/161*y + 339/322)]~];/*Level 9*/
O1 = algorderalgtomatrix(A, O1bas);
if(!algisorder(A, O1), print("Not an order"));
print(algorderlevel(A, O1, 0));
X = afuchinit(A, O1, , 2);
print(afuchsignature(X));
X = afuchmakepresentation(X);
P = afuchpresentation(X);
print(length(P[1]));
